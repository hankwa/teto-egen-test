import { CreateWebWorkerMLCEngine } from "https://esm.run/webllm";

export async function generateResult(features, emotionScore, userType) {
  // few-shot ê´€ìƒ/ë™ë¬¼í˜• reference ë°ì´í„°
  const fewShotExamples = `
ì˜ˆì‹œ 1ï¸âƒ£
ì…ë ¥:
- ë™ë¬¼í˜•: ê³ ì–‘ì´ìƒ ğŸ±
- ì–¼êµ´ íŠ¹ì§•: í„±ì´ ë‚ ë µí•˜ê³  ì…ì´ ì‘ìœ¼ë©° ëˆˆì¹ ê°ë„ê°€ ë†’ìŒ
- ê°ì„±ì§€ìˆ˜: 0.32 (ì´ì„±í˜•)
- ìœ í˜•: í…Œí† í˜•
ì¶œë ¥:
ë‹¹ì‹ ì€ ğŸ± ê³ ì–‘ì´ìƒ í…Œí† í˜•ì…ë‹ˆë‹¤.
ì°¨ë¶„í•˜ê³  ìƒí™©ì„ ë…¼ë¦¬ì ìœ¼ë¡œ ë°”ë¼ë³´ëŠ” íƒ€ì…ì´ì—ìš”. ë‹¨í˜¸í•˜ì§€ë§Œ ê°ì • í‘œí˜„ì€ ì ˆì œë˜ì–´ ìˆì£ .
ì´ì„±ì  ì‚¬ê³ ê°€ ê°•í•˜ì§€ë§Œ, ë‚´ë©´ì—” ì¡°ìš©í•œ ë”°ëœ»í•¨ì´ ìˆ¨ì–´ ìˆìŠµë‹ˆë‹¤.
âœ¨ #ê´€ì°°ë ¥ #ê²°ë‹¨ë ¥ #ì§€ì ë§¤ë ¥
ì—°ì• ìŠ¤íƒ€ì¼: ì‹ ì¤‘í•œ ê´€ì°°ìí˜•
ë§ˆì§€ë§‰ ë¬¸ì¥: ë‹¹ì‹ ì˜ ëˆˆë¹›ì—ëŠ” ê³ ìš”í•œ ì§‘ì¤‘ë ¥ì´ ê¹ƒë“¤ì–´ ìˆìŠµë‹ˆë‹¤.

---

ì˜ˆì‹œ 2ï¸âƒ£
ì…ë ¥:
- ë™ë¬¼í˜•: ê°•ì•„ì§€ìƒ ğŸ¶
- ì–¼êµ´ íŠ¹ì§•: ë³¼ì´ ë‘¥ê¸€ê³  ì…ê¼¬ë¦¬ê°€ ìœ„ë¡œ ì˜¬ë¼ê°
- ê°ì„±ì§€ìˆ˜: 0.82 (ê°ì„±í˜•)
- ìœ í˜•: ì—ê²í˜•
ì¶œë ¥:
ë‹¹ì‹ ì€ ğŸ¶ ê°•ì•„ì§€ìƒ ì—ê²í˜•ì…ë‹ˆë‹¤.
ê°ì •ì— ì†”ì§í•˜ê³  ë”°ëœ»í•œ ë§íˆ¬ë¡œ ì‚¬ëŒë“¤ì„ í¸í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.
ê³µê° ëŠ¥ë ¥ì´ ë†’ì•„ íƒ€ì¸ì˜ ê¸°ë¶„ì„ ì‰½ê²Œ ì½ì–´ìš”.
âœ¨ #ê³µê°ë ¥ #í¬ìš©ë ¥ #ë”°ëœ»í•œì—ë„ˆì§€
ì—°ì• ìŠ¤íƒ€ì¼: ê°ì •ê³µìœ í˜•
ë§ˆì§€ë§‰ ë¬¸ì¥: ë‹¹ì‹ ì˜ ë¯¸ì†ŒëŠ” ì‚¬ëŒë“¤ì˜ í•˜ë£¨ë¥¼ ë¶€ë“œëŸ½ê²Œ ë…¹ì—¬ì¤ë‹ˆë‹¤.

---

ì˜ˆì‹œ 3ï¸âƒ£
ì…ë ¥:
- ë™ë¬¼í˜•: ì—¬ìš°ìƒ ğŸ¦Š
- ì–¼êµ´ íŠ¹ì§•: ì…ê¼¬ë¦¬ê°€ ì‚´ì§ ì˜¬ë¼ê°€ê³  ëˆˆë§¤ê°€ ìœ í˜¹ì ìœ¼ë¡œ ê¸°ìš¸ì–´ ìˆìŒ
- ê°ì„±ì§€ìˆ˜: 0.55 (ê· í˜•í˜•)
- ìœ í˜•: í…Œê²í˜•
ì¶œë ¥:
ë‹¹ì‹ ì€ ğŸ¦Š ì—¬ìš°ìƒ í…Œê²í˜•ì…ë‹ˆë‹¤.
í˜„ì‹¤ê°ê³¼ ê°ê°ì„ ëª¨ë‘ ì§€ë‹Œ ê· í˜•í˜•ì´ì—ìš”. ìƒí™© íŒë‹¨ì´ ë¹ ë¥´ê³ , í‘œí˜„ë ¥ê³¼ ì§ê´€ì´ ë›°ì–´ë‚©ë‹ˆë‹¤.
ë•Œë¡  ëƒ‰ì² í•˜ì§€ë§Œ, ê´€ê³„ ì†ì—ì„œ ë§¤ë ¥ì„ ë°œì‚°í•˜ëŠ” ì‚¬ëŒì…ë‹ˆë‹¤.
âœ¨ #ê°ê°ì  #ê· í˜•ê°ê° #í‘œí˜„ë ¥
ì—°ì• ìŠ¤íƒ€ì¼: ì§ê°í˜• ë§¤ë ¥ëŸ¬ë²„
ë§ˆì§€ë§‰ ë¬¸ì¥: ë‹¹ì‹ ì˜ ëˆˆë¹›ì€ ë…¼ë¦¬ì™€ ê°ì„±ì´ êµì°¨í•˜ëŠ” í™©ê¸ˆë¹„ìœ¨ì„ ì§€ë…”ìŠµë‹ˆë‹¤.

---

ì˜ˆì‹œ 4ï¸âƒ£
ì…ë ¥:
- ë™ë¬¼í˜•: ê³°ìƒ ğŸ»
- ì–¼êµ´ íŠ¹ì§•: í„±ì„ ì´ ë‘¥ê¸€ê³  ì…ì´ ë‹¨ë‹¨í•˜ë©° ëˆˆë§¤ê°€ ì˜¨í™”í•¨
- ê°ì„±ì§€ìˆ˜: 0.48 (ì¤‘ë¦½í˜•)
- ìœ í˜•: í…Œê²í˜•
ì¶œë ¥:
ë‹¹ì‹ ì€ ğŸ» ê³°ìƒ í…Œê²í˜•ì…ë‹ˆë‹¤.
ì˜¨í™”í•˜ê³  ì‹ ì¤‘í•œ ì‚¬ëŒìœ¼ë¡œ, ì£¼ìœ„ì— ì•ˆì •ê°ì„ ì¤ë‹ˆë‹¤.
ê°ì •ì˜ ê¸°ë³µì´ ì ê³ , ê¾¸ì¤€í•œ ì‹ ë¢°ë¥¼ ìŒ“ëŠ” íƒ€ì…ì´ì—ìš”.
âœ¨ #ì•ˆì •ê° #ì„±ì‹¤í•¨ #ë”°ëœ»í•œë¦¬ë”
ì—°ì• ìŠ¤íƒ€ì¼: ë°°ë ¤í˜• í—Œì‹ ëŸ¬ë²„
ë§ˆì§€ë§‰ ë¬¸ì¥: ë‹¹ì‹ ì˜ ì¡´ì¬ëŠ” ì£¼ë³€ì— í¬ê·¼í•œ ì•ˆì •ê°ì„ ì„ ë¬¼í•©ë‹ˆë‹¤.

---

ì˜ˆì‹œ 5ï¸âƒ£
ì…ë ¥:
- ë™ë¬¼í˜•: ì‚¬ìŠ´ìƒ ğŸ¦Œ
- ì–¼êµ´ íŠ¹ì§•: ì–¼êµ´í˜•ì´ ê· í˜• ì¡íˆê³  ëˆˆë§¤ê°€ ë¶€ë“œëŸ¬ì›€
- ê°ì„±ì§€ìˆ˜: 0.58 (ê· í˜•í˜•)
- ìœ í˜•: í…Œê²í˜•
ì¶œë ¥:
ë‹¹ì‹ ì€ ğŸ¦Œ ì‚¬ìŠ´ìƒ í…Œê²í˜•ì…ë‹ˆë‹¤.
ê°ì„±ê³¼ ì´ì„±ì„ ì¡°í™”ë¡­ê²Œ ë‹¤ë£¨ëŠ” ì¤‘ì¬ìí˜•ì´ì—ìš”.
ì„¬ì„¸í•˜ë©´ì„œë„ í˜„ì‹¤ì ì¸ íŒë‹¨ë ¥ì„ ê°€ì¡ŒìŠµë‹ˆë‹¤.
âœ¨ #ì¡°í™” #ê°ì„±ì§€ëŠ¥ #ê· í˜•ê°ê°
ì—°ì• ìŠ¤íƒ€ì¼: ì‹ ì¤‘í•œ ê³µê°ëŸ¬ë²„
ë§ˆì§€ë§‰ ë¬¸ì¥: ë‹¹ì‹ ì˜ ì‹œì„ ì€ ì‚¬ëŒë“¤ì—ê²Œ í¸ì•ˆí•œ ì—¬ë°±ì„ ë‚¨ê¹ë‹ˆë‹¤.
`;

  // ğŸ§© ì‹¤ì œ ì‚¬ìš©ì ì…ë ¥
  const prompt = `
${fewShotExamples}

---

ì…ë ¥:
- ë™ë¬¼í˜•: ${features.animalType} ${features.animalEmoji}
- ì–¼êµ´ íŠ¹ì§•: ëˆˆì¹ê°ë„ ${features.eyebrowAngle.toFixed(1)}Â°, ì…ê¼¬ë¦¬ê³¡ë¥  ${features.mouthCurve.toFixed(2)}, í„±ì„ ê°ë„ ${features.jawSharpness.toFixed(2)}
- ê°ì„±ì§€ìˆ˜: ${emotionScore.toFixed(2)}
- ìœ í˜•: ${userType}

ì¶œë ¥:
`;

  // ğŸ§  WebLLM í˜¸ì¶œ
  const engine = await CreateWebWorkerMLCEngine(
    "TinyLlama-1.1B-Chat-v0.3-q4f16_1-MLC",
    {
      initProgressCallback: (p) => {
        console.log("ëª¨ë¸ ë¡œë”©:", (p.progress * 100).toFixed(1) + "%");
      },
    }
  );

  const reply = await engine.chat.completions.create({
    messages: [
      {
        role: "system",
        content: `
ë‹¹ì‹ ì€ ë™ì–‘ ê´€ìƒí•™ê³¼ ì‹¬ë¦¬í•™ì„ ê²°í•©í•œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì–¼êµ´í˜•, í‘œì •, ê°ì„±ì§€ìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„±ê²©ì  íŠ¹ì§•ê³¼ ì¸ìƒ, ë¶„ìœ„ê¸°ë¥¼
ì‚¬ëŒì˜ ì´ì•¼ê¸°ë¥¼ í•˜ë“¯ ë”°ëœ»í•˜ê²Œ ë¬˜ì‚¬í•˜ì„¸ìš”.
ê²°ê³¼ëŠ” ê°ì •ì ì´ë˜ ê³¼ì¥ë˜ì§€ ì•Šê²Œ, ì„œì •ì  ë¬¸ì²´ë¡œ í‘œí˜„í•˜ì„¸ìš”.
`,
      },
      { role: "user", content: prompt },
    ],
    temperature: 0.75,
  });

  return reply.choices[0].message.content;
}