import { CreateWebWorkerMLCEngine } from "https://esm.run/webllm";

export async function generateResult(features, emotionScore, userType) {
  // few-shot 관상/동물형 reference 데이터
  const fewShotExamples = `
예시 1️⃣
입력:
- 동물형: 고양이상 🐱
- 얼굴 특징: 턱이 날렵하고 입이 작으며 눈썹 각도가 높음
- 감성지수: 0.32 (이성형)
- 유형: 테토형
출력:
당신은 🐱 고양이상 테토형입니다.
차분하고 상황을 논리적으로 바라보는 타입이에요. 단호하지만 감정 표현은 절제되어 있죠.
이성적 사고가 강하지만, 내면엔 조용한 따뜻함이 숨어 있습니다.
✨ #관찰력 #결단력 #지적매력
연애스타일: 신중한 관찰자형
마지막 문장: 당신의 눈빛에는 고요한 집중력이 깃들어 있습니다.

---

예시 2️⃣
입력:
- 동물형: 강아지상 🐶
- 얼굴 특징: 볼이 둥글고 입꼬리가 위로 올라감
- 감성지수: 0.82 (감성형)
- 유형: 에겐형
출력:
당신은 🐶 강아지상 에겐형입니다.
감정에 솔직하고 따뜻한 말투로 사람들을 편하게 만듭니다.
공감 능력이 높아 타인의 기분을 쉽게 읽어요.
✨ #공감력 #포용력 #따뜻한에너지
연애스타일: 감정공유형
마지막 문장: 당신의 미소는 사람들의 하루를 부드럽게 녹여줍니다.

---

예시 3️⃣
입력:
- 동물형: 여우상 🦊
- 얼굴 특징: 입꼬리가 살짝 올라가고 눈매가 유혹적으로 기울어 있음
- 감성지수: 0.55 (균형형)
- 유형: 테겐형
출력:
당신은 🦊 여우상 테겐형입니다.
현실감과 감각을 모두 지닌 균형형이에요. 상황 판단이 빠르고, 표현력과 직관이 뛰어납니다.
때론 냉철하지만, 관계 속에서 매력을 발산하는 사람입니다.
✨ #감각적 #균형감각 #표현력
연애스타일: 직감형 매력러버
마지막 문장: 당신의 눈빛은 논리와 감성이 교차하는 황금비율을 지녔습니다.

---

예시 4️⃣
입력:
- 동물형: 곰상 🐻
- 얼굴 특징: 턱선이 둥글고 입이 단단하며 눈매가 온화함
- 감성지수: 0.48 (중립형)
- 유형: 테겐형
출력:
당신은 🐻 곰상 테겐형입니다.
온화하고 신중한 사람으로, 주위에 안정감을 줍니다.
감정의 기복이 적고, 꾸준한 신뢰를 쌓는 타입이에요.
✨ #안정감 #성실함 #따뜻한리더
연애스타일: 배려형 헌신러버
마지막 문장: 당신의 존재는 주변에 포근한 안정감을 선물합니다.

---

예시 5️⃣
입력:
- 동물형: 사슴상 🦌
- 얼굴 특징: 얼굴형이 균형 잡히고 눈매가 부드러움
- 감성지수: 0.58 (균형형)
- 유형: 테겐형
출력:
당신은 🦌 사슴상 테겐형입니다.
감성과 이성을 조화롭게 다루는 중재자형이에요.
섬세하면서도 현실적인 판단력을 가졌습니다.
✨ #조화 #감성지능 #균형감각
연애스타일: 신중한 공감러버
마지막 문장: 당신의 시선은 사람들에게 편안한 여백을 남깁니다.
`;

  // 🧩 실제 사용자 입력
  const prompt = `
${fewShotExamples}

---

입력:
- 동물형: ${features.animalType} ${features.animalEmoji}
- 얼굴 특징: 눈썹각도 ${features.eyebrowAngle.toFixed(1)}°, 입꼬리곡률 ${features.mouthCurve.toFixed(2)}, 턱선각도 ${features.jawSharpness.toFixed(2)}
- 감성지수: ${emotionScore.toFixed(2)}
- 유형: ${userType}

출력:
`;

  // 🧠 WebLLM 호출
  const engine = await CreateWebWorkerMLCEngine(
    "TinyLlama-1.1B-Chat-v0.3-q4f16_1-MLC",
    {
      initProgressCallback: (p) => {
        console.log("모델 로딩:", (p.progress * 100).toFixed(1) + "%");
      },
    }
  );

  const reply = await engine.chat.completions.create({
    messages: [
      {
        role: "system",
        content: `
당신은 동양 관상학과 심리학을 결합한 전문가입니다.
얼굴형, 표정, 감성지수를 기반으로 성격적 특징과 인상, 분위기를
사람의 이야기를 하듯 따뜻하게 묘사하세요.
결과는 감정적이되 과장되지 않게, 서정적 문체로 표현하세요.
`,
      },
      { role: "user", content: prompt },
    ],
    temperature: 0.75,
  });

  return reply.choices[0].message.content;
}